# 施設マスタ画面仕様書

## 1. 目的
- 拠点・店舗・事業所などの「施設」情報を一元管理し、運用担当が最新状態を把握・更新できる画面を提供する。
- 施設の追加・更新・無効化を安全に行い、各種業務システムと整合したマスターデータを維持する。

## 2. 利用者とユースケース
- **利用者**
  - 本部の管理担当、拠点管理者、システム管理者。
- **代表ユースケース**
  1. 新規に開設する施設を登録し、コードや所在地などの基本情報を設定する。
  2. 既存施設の名称変更や連絡先更新を行う。
  3. 閉鎖した施設を無効化し、業務システムへの同期対象から除外する。
  4. 施設一覧を確認し、所在地・種別・稼働状況などを参照する。

## 3. 機能概要
- 施設一覧表示
  - 施設コード、名称、種別、所在地（都道府県／住所）、稼働ステータス、主要連絡先を表形式で提示。
  - ビジネス利用の多い順序（例: コード昇順または名称昇順）で表示。
- 検索とフィルタリング
  - キーワード検索：施設名称、施設コード、所在地などを対象とした部分一致検索
  - 種別フィルタ：本社、支社、倉庫、店舗など施設種別での絞り込み
  - ステータスフィルタ：稼働中、休止、無効など稼働ステータスでの絞り込み
  - 検索処理はサーバー側で実行し、結果のみをクライアントに返す
- 施設登録
  - 新規施設の基本情報（コード・名称・種別・所在地・連絡先・稼働開始日など）を入力して登録する。
  - コードの重複チェックを行い、重複時はエラー表示。
- 施設編集
  - 既存施設の属性（名称、所在地、担当者情報、稼働ステータスなど）を更新できる。
  - 必要に応じて稼働開始／終了日を設定・更新する。
- 施設の有効／無効化
  - 稼働終了または一時停止状態を設定できる。
  - 無効化時には確認メッセージを表示し、業務影響を周知。
- 施設削除
  - 原則として論理削除（無効化）を推奨。完全削除が必要な場合は、履歴保持の要否を検討して決定する。
- データ更新の反映
  - CRUD 操作後、一覧を再読込して最新状態を表示する。
- 状態表示
  - 読み込み中、エラー、データ未登録などの状態を画面で明示する。

## 4. 画面構成（機能レベル）
- **検索エリア**
  - キーワード検索テキストフィールド：施設名称、施設コード、所在地などを対象に部分一致で検索
  - 種別フィルタドロップダウン：全て／本社／支社／倉庫／店舗から選択
  - ステータスフィルタドロップダウン：全て／稼働中／休止／無効から選択
  - 検索条件の変更は即座にサーバーに送信され、結果が一覧に反映される
- **操作バー**
  - 「施設追加」「一覧更新」「CSV ダウンロード」など頻度の高い操作を集約する。
- **一覧テーブル**
  - 主要カラム例: 施設コード、施設名称、種別、所在地（都道府県／市区町村／住所略称）、稼働ステータス、稼働開始日、連絡先（代表電話／メール）、最終更新日時。
  - 行ごとに編集／無効化／削除の操作ボタンを配置。
- **モーダル／ダイアログ**
  - 施設追加・編集で共通使用。入力項目と検証メッセージ、保存・キャンセル操作を含む。
  - 項目は縦方向に一列で並べ、入力領域のみスクロールさせる。タイトルと操作ボタンは固定表示し、長大なフォームでもボタンが常時見えるようにする。
  - フロントエンドでは react-hook-form と Zod による入力チェックを行い、必須項目や書式エラーを各入力欄に表示する。
- **状態表示領域**
  - 非同期処理中のインジケーター、エラーメッセージ、データなし時の案内メッセージを表示。

## 5. データ項目と制約（案）
| 項目 | 必須 | 入力形式／制約 | 備考 |
| --- | --- | --- | --- |
| 施設コード | 必須 | 英数字・ハイフン。ユニーク。最大 16 文字程度 | 外部システム連携に利用 |
| 施設名称 | 必須 | 文字列（1〜100 文字） | 表示名 |
| 施設種別 | 必須 | 定義済みカテゴリ（例: 本社、支社、倉庫、店舗 等） | マスタデータを別途管理 |
| 稼働ステータス | 必須 | `ACTIVE` / `INACTIVE` / `SUSPENDED` など | 状態に応じて一覧のスタイル変更可 |
| 都道府県 | 必須 | 都道府県マスタから選択 | 海外拠点がある場合は国別対応を検討 |
| 市区町村／住所 | 任意 | 文字列（最大 200 文字） | 住所全体を単一項目で扱う案もあり |
| 代表電話番号 | 任意 | 電話番号書式 | フォーマット統一は後続検討 |
| 代表メールアドレス | 任意 | メール形式 | 複数担当者がいる場合は連絡先管理機能を拡張 |
| 稼働開始日 | 任意 | 日付 | 稼働期間の管理に利用 |
| 稼働終了日 | 任意 | 日付。開始日以降 | 無効化時に設定 |
| 備考 | 任意 | 最大 500 文字 | 特記事項 |
| 最終更新者／日時 | 自動 | 読み取り専用 | 監査ログとして表示 |

※ 実装時には、住所・連絡先などの入力フォーマットやマスタデータ（種別・都道府県）取得方法を別途定義する。

## 6. 業務ルール・バリデーション
- 施設コードは重複不可。新規登録時にサーバー側で一意制約をチェック。
- 稼働終了日を設定する場合、稼働開始日以前の日付は無効とする。
- 稼働ステータスが `INACTIVE` になるタイミングで、関連システムへの同期やアラートを検討。
- 必須項目未入力時は保存不可とし、エラーメッセージで不足項目を明示する。
- 連絡先情報の入力書式は可能な限りガイド（プレースホルダー、バリデーション）を用意する。

## 7. ロール・権限に関する補足
- 施設マスタの閲覧は原則全管理者が可能。
- 登録・更新・無効化は管理者権限を持つユーザーのみに制限する想定。
- ロール要件が追加された場合は、ボタン表示／操作可否を権限に基づいて制御する。

## 8. 非機能要件（画面単位）
- 検索レスポンス: 一覧の取得は 3 秒以内を目標。
- 操作のフィードバック: 送信中はボタンの二重押下を防止し、完了後に成功／失敗を明示。
- アクセシビリティ: ラベル・フォーカス・キーボード操作を考慮。コンテンツは日本語を基準としつつ、英語表示への拡張余地を残す。
- 監査性: CRUD 操作履歴をバックエンドで記録し、必要に応じて画面上に最終更新情報を表示。

## 9. 検索項目仕様

### 9.1 検索項目一覧

| 項目名 | フィールドキー | 検索方式 | 備考 |
| --- | --- | --- | --- |
| キーワード | `keyword` | 部分一致 | 施設名称、施設コード、都道府県、市区町村、住所を対象 |
| 種別 | `category` | 完全一致 | `ALL`, `HEAD`, `BRANCH`, `WAREHOUSE`, `STORE` |
| ステータス | `status` | 完全一致 | `ALL`, `ACTIVE`, `INACTIVE`, `SUSPENDED`, `CLOSED` |

### 9.2 検索処理フロー

1. ユーザーが検索条件を入力・変更
2. フロントエンドから tRPC 経由でサーバーに検索条件を送信
3. サーバー側で Prisma を使用してデータベースクエリを実行
   - キーワード検索は `contains` モードで `name`, `code`, `prefecture`, `city`, `addressLine1` に OR 条件を適用
   - 種別フィルタは `category` フィールドに完全一致条件を適用
   - ステータスフィルタは `status` フィールドに完全一致条件を適用
4. 検索結果をページング情報と共にクライアントに返却
5. フロントエンドで結果を一覧表示

### 9.3 技術的考慮事項

- 検索クエリのパフォーマンス確保のため、`name`, `code` カラムにインデックスを設定
- 大量データ対応として、結果はページング（デフォルト 20 件/ページ）で返却
- 検索条件はクエリパラメータに保持し、ブラウザの戻る/進むに対応

## 10. 今後の拡張アイデア
- 都道府県単独でのフィルタリング。
- 稼働開始日・終了日による期間検索。
- 一括登録／更新（CSV インポート／エクスポート）。
- 関連情報（担当者一覧、収容人数、設備情報など）との連携ビュー。
- 地図表示や所在地の自動補完（外部 API 連携）。

## 11. 施設項目一覧（定義）

| No. | 項目名 (UI ラベル) | フィールドキー案 | 種別 | 必須 | 入力仕様／制約 | 表示箇所 | 備考 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 1 | 施設コード | `code` | 文字列 | 必須 | 英数字・ハイフン、最大 16 文字、ユニーク | 一覧／詳細 | 外部連携 ID として使用 |
| 2 | 施設名称 | `name` | 文字列 | 必須 | 1〜100 文字 | 一覧／詳細 | 表示名 |
| 3 | 施設名称（カナ） | `nameKana` | 文字列 | 任意 | 全角カナ 1〜100 文字 | 詳細 | 音声案内などに利用 |
| 4 | 施設種別 | `category` | 列挙型 | 必須 | `HEAD`, `BRANCH`, `WAREHOUSE`, `STORE` など定義済み | 一覧／詳細 | マスタ｢FacilityCategory｣参照 |
| 5 | 稼働ステータス | `status` | 列挙型 | 必須 | `ACTIVE`, `INACTIVE`, `SUSPENDED`, `CLOSED` など | 一覧／詳細 | 状態により行スタイル変更 |
| 6 | 稼働開始日 | `startDate` | 日付 | 任意 | ISO8601 日付、現在以降を推奨 | 一覧／詳細 | 稼働中判定に利用 |
| 7 | 稼働終了日 | `endDate` | 日付 | 任意 | `startDate` 以降の日付 | 詳細 | 無効化時に設定 |
| 8 | 国 | `country` | 列挙型 | 任意 | ISO3166-1 alpha-2 | 詳細 | 海外拠点用。未入力時は `JP` 扱い |
| 9 | 都道府県 | `prefecture` | 列挙型 | 必須 | 都道府県コード（1〜47） | 一覧／詳細 | `country` が `JP` の場合 |
| 10 | 市区町村 | `city` | 文字列 | 任意 | 最大 100 文字 | 詳細 | 日本語表記 |
| 11 | 住所詳細 | `addressLine1` | 文字列 | 任意 | 最大 200 文字 | 詳細 | 番地・建物名 |
| 12 | 郵便番号 | `postalCode` | 文字列 | 任意 | 数字 7 桁または `NNN-NNNN` | 詳細 | 自動補完のトリガー候補 |
| 13 | GIS 座標 (緯度) | `latitude` | 数値 | 任意 | -90〜90、小数点 6 桁程度 | 詳細 | 地図表示向け |
| 14 | GIS 座標 (経度) | `longitude` | 数値 | 任意 | -180〜180、小数点 6 桁程度 | 詳細 | 地図表示向け |
| 15 | 代表電話番号 | `phoneNumber` | 文字列 | 任意 | 国際番号含む E.164 推奨 | 詳細 | 表示と連絡用 |
| 16 | 代表メールアドレス | `email` | 文字列 | 任意 | メール形式 | 詳細 | 施設代表窓口 |
| 17 | 担当者氏名 | `contactName` | 文字列 | 任意 | 最大 100 文字 | 詳細 | 拠点責任者等 |
| 18 | 担当者電話番号 | `contactPhone` | 文字列 | 任意 | 電話番号形式 | 詳細 | |
| 19 | 担当者メール | `contactEmail` | 文字列 | 任意 | メール形式 | 詳細 | |
| 20 | 収納能力／定員 | `capacity` | 数値 | 任意 | 正整数（最大 99999） | 詳細 | 倉庫、施設規模の目安 |
| 21 | 備考 | `note` | 文字列 | 任意 | 最大 500 文字 | 詳細 | 特記事項 |
| 22 | 画像 URL | `imageUrl` | 文字列 | 任意 | URL 形式 | 詳細 | 施設写真 |
| 23 | 最終同期日時 | `syncedAt` | 日時 | 自動 | ISO8601 | 一覧／詳細 | 外部連携基準 |
| 24 | 最終更新日時 | `updatedAt` | 日時 | 自動 | ISO8601 | 一覧／詳細 | 画面読み取りのみ |
| 25 | 最終更新者 | `updatedBy` | 文字列 | 自動 | ユーザー ID | 詳細 | 監査用 |
| 26 | 作成日時 | `createdAt` | 日時 | 自動 | ISO8601 | 詳細 | 画面読み取りのみ |
| 27 | 作成者 | `createdBy` | 文字列 | 自動 | ユーザー ID | 詳細 | 監査用 |
| 28 | 表示順 | `displayOrder` | 数値 | 任意 | 0 以上の整数 | 一覧 | 特定順序で表示したい場合 |
| 29 | 外部システム連携フラグ | `isIntegrated` | 真偽値 | 自動 | 内部計算 | 一覧／詳細 | 連携済み施設を明示 |
| 30 | 支払先コード | `billingCode` | 文字列 | 任意 | 文字列（最大 32 文字） | 詳細 | 請求処理向け |

> 上記は初期案であり、実装フェーズで業務要件と照らして精査する。特に住所・連絡先フォーマット、種別／ステータスのコード体系、GIS 情報の扱いについてはインフラ／業務システム担当と調整が必要。***
