# ユーザー画面テスト仕様書

## 1. 目的
- ユーザー管理ダッシュボードが仕様通りに動作することを、フロントエンド・バックエンド・E2E の各レイヤーで検証する。
- 既存の自動テストコードとテストケースを紐付け、回帰時の網羅性を把握できるようにする。

## 2. 対象範囲
- 画面: `HomePage`, `UserTable`。
- API: `user.list`, `user.create`, `user.update`, `user.delete`。
- テスト層:
  - **Backend**: ユースケース単位のユニットテスト（Vitest）。
  - **Frontend**: React コンポーネントテスト（Vitest + RTL）。
  - **E2E**: ブラウザ自動操作による結合テスト（Playwright）。

## 3. 前提条件／環境
- `pnpm install` 済み。
- Backend/Frontend テスト: `pnpm test` で実行可能。
- E2E テスト: `pnpm dev`（必要なら `dev:server`）でアプリ起動後、`pnpm test:e2e` を実行。
- テストデータはインメモリリポジトリもしくは Playwright 実行中に作成・削除される。

## 4. テスト観点
- ユーザー CRUD フローの正常系／異常系。
- エラーハンドリングと確認ダイアログ。
- 一覧表示・状態表示（読み込み・空状態）。
- データ整合性（重複防止、未存在エラー、キャッシュ更新）。

## 5. テストケース一覧

### 5.1 Backend（Vitest） — `tests/backend/user/use-cases.test.ts`

| ID | シナリオ | 観点 | 期待結果 | 自動化 |
| --- | --- | --- | --- | --- |
| B-01 | 新規ユーザー作成 | 正常系 | ユーザーが作成され、リポジトリに1件保存される | 実装済み |
| B-02 | メール重複の拒否 | 異常系（検証） | 既存メールで作成すると `EMAIL_ALREADY_EXISTS` が投げられる | 実装済み |
| B-03 | ユーザー一覧取得 | 表示 | 作成済みユーザーが配列で取得できる | 実装済み |
| B-04 | ユーザー更新 | 正常系 | 指定フィールドのみ更新され、他属性は維持される | 実装済み |
| B-05 | 存在しないユーザー更新 | 異常系（存在確認） | 未登録 ID で更新すると `USER_NOT_FOUND` 例外 | 実装済み |
| B-06 | ユーザー削除 | 正常系 | 対象ユーザーが削除され、件数が減少する | 実装済み |
| B-07 | 存在しないユーザー削除 | 異常系（存在確認） | 未登録 ID で削除すると `USER_NOT_FOUND` 例外 | 実装済み |
| B-08 | キーワード検索（氏名） | 検索機能 | キーワードで氏名を部分一致検索できる | 実装済み |
| B-09 | キーワード検索（メール） | 検索機能 | キーワードでメールアドレスを部分一致検索できる | 実装済み |
| B-10 | キーワード検索（部署） | 検索機能 | キーワードで部署名を部分一致検索できる | 実装済み |
| B-11 | 権限フィルタ | 検索機能 | 特定の権限でユーザーをフィルタリングできる | 実装済み |
| B-12 | キーワードと権限の複合検索 | 検索機能 | キーワードと権限フィルタを組み合わせて検索できる | 実装済み |
| B-13 | 検索条件なし | 検索機能 | 検索条件がない場合は全ユーザーを取得できる | 実装済み |

### 5.2 Frontend（Vitest + RTL） — `tests/frontend/user-table.test.tsx`

| ID | シナリオ | 観点 | 期待結果 | 自動化 |
| --- | --- | --- | --- | --- |
| F-01 | 一覧の表示 | 表示 | クエリ結果のユーザー名・メールがテーブルに表示される | 実装済み |
| F-02 | ユーザー追加フロー | 正常系 | 追加ダイアログで入力して保存すると `create.mutate` がデフォルト値（`role=USER`, `status=INVITED`, `image=null`）付きで呼ばれる | 実装済み |
| F-03 | ユーザー編集フロー | 正常系 | 編集モーダルから更新すると `update.mutate` が ID と変更後情報で呼ばれる | 実装済み |
| F-04 | ユーザー削除フロー | 正常系 | `window.confirm` 承諾後に `delete.mutate` が ID 付きで呼ばれる | 実装済み |
| F-05 | 読み込み状態表示 | 状態 | `isLoading` の場合に「読み込み中...」を表示する | 未実装（追加推奨） |
| F-06 | 空状態表示 | 状態 | 空配列のとき「ユーザーが登録されていません。」が表示される | 未実装（追加推奨） |
| F-07 | Mutation エラー表示 | 異常系 | `create/update` 失敗時にエラー Alert が表示される | 未実装（追加推奨） |

### 5.3 E2E（Playwright） — `tests/e2e/user-crud.spec.ts`

| ID | シナリオ | 観点 | 期待結果 | 自動化 |
| --- | --- | --- | --- | --- |
| E-01 | CRUD 一連操作 | 正常系 | 追加 → 編集 → 削除 の操作を通して UI が更新される | 実装済み |
| E-02 | サーバーヘルスチェック | 前提 | テスト前に API 健全性を確認し、起動していない場合は実行を停止する | 実装済み |
| E-03 | 削除キャンセル | 異常系（利用者操作） | 削除ダイアログでキャンセルした場合ユーザーが残る | 未実装（追加推奨） |
| E-04 | 重複メール登録 | 異常系（検証） | 既存ユーザーと同一メールで登録し、エラー表示を確認する | 未実装（追加推奨） |

## 6. カバレッジマッピング
- **Backend**: CRUD 正常系と主要な異常系を網羅（B-01〜B-07）。
- **Frontend**: CRUD ハッピーケースを自動化済み（F-01〜F-04）。状態表示・エラーハンドリングは今後補完（F-05〜F-07）。
- **E2E**: 一連の CRUD フローを通し確認済み（E-01）。追加異常系は今後の課題（E-03, E-04）。

## 7. 今後の拡張テスト
- UI 状態変化（ローディング・空・エラー）の自動テスト追加。
- Playwright での確認ダイアログキャンセル、異常系エラー表示の自動化。
- API レイヤー単体でのソート順・フィルタリング（将来機能）に対するテスト。
- 非同期エラー発生時のロギング／モニタリング確認テスト。

## 8. 留意事項
- API エラーメッセージ文言変更時はフロント・E2E テストも更新が必要。
- Playwright では `window.confirm` を `page.on("dialog")` で制御する。キャンセル検証時は `dialog.dismiss()` を使用する。
- 追加テストを実装する際は、テストデータのクリーンアップ（特に E2E）に注意する。
