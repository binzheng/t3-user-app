# 施設マスタ画面テスト仕様書

## 1. 目的
- 施設マスタ画面と関連 API が仕様通りに動作することを検証し、運用中のデータ品質を担保する。
- 施設 CRUD の正常系／異常系、表示状態、業務ルールを自動テストと手動テストで網羅する。

## 2. 対象範囲
- 画面: 施設マスタ一覧・登録/編集モーダル。
- API/ユースケース: `facility.list`, `facility.create`, `facility.update`, `facility.deactivate`/`facility.delete`（名称は実装時に確定）。
- テストレイヤー:
  - **Backend**: ユースケース単体テスト（Vitest）。
  - **Frontend**: React コンポーネントテスト（Vitest + RTL）。
  - **E2E**: ブラウザ自動テスト（Playwright）。

## 3. 前提条件／環境
- `pnpm install` 済み。
- Backend/Frontend テスト: `pnpm test`。
- E2E テスト: `pnpm dev`（必要であれば API サーバー併走）後に `pnpm test:e2e`。
- テストデータ: 施設マスタの初期データを Prisma Seed もしくはモックで準備。空状態／複数データ／無効施設を切り替えられるようにする。
- 認証要件: 管理者権限ユーザーとして操作する想定。

## 4. テスト観点
- 施設一覧の表示・並び順・状態表示。
- 登録／編集の正常系、必須項目不足、コード重複、ステータス更新。
- 無効化（論理削除）前の確認および結果反映。
- 稼働開始日／終了日の整合性、所在地・連絡先のフォーマット。
- 一覧更新、空・エラー状態のハンドリング。

## 5. テストケース一覧

### 5.1 Backend（Vitest） — 予定: `tests/backend/facility/*.test.ts`

| ID | シナリオ | 観点 | 期待結果 | 自動化 | 備考 |
| --- | --- | --- | --- | --- | --- |
| B-01 | 施設を新規登録 | 正常系 | 一意なコードで作成し、リポジトリに保存される | 実装済み | 必須項目: コード/名称/種別/ステータス/都道府県 |
| B-02 | コード重複で登録失敗 | 異常系（検証） | 既存コードで作成すると `FACILITY_CODE_EXISTS` エラー | 実装済み | |
| B-03 | 一覧取得 | 表示 | 施設リストがコード昇順で返る | 実装済み | 並び順ロジック検証 |
| B-04 | 施設編集 | 正常系 | 名称・所在地・連絡先などが更新される | 実装済み | null/空文字の扱い確認 |
| B-05 | 稼働終了日とステータス更新 | 正常系 | 終了日設定後、ステータスが `INACTIVE` になる | 未実装 | 業務ルール遵守 |
| B-06 | 稼働終了日が開始日前でエラー | 異常系（整合性） | `startDate` > `endDate` で `INVALID_PERIOD` エラー | 未実装 | |
| B-07 | 無効化（論理削除） | 正常系 | `isActive=false` となり、同期対象から除外される | 実装済み | |
| B-08 | 未存在施設の更新/削除 | 異常系 | `FACILITY_NOT_FOUND` エラー | 実装済み | |
| B-09 | キーワード検索（施設名） | 検索機能 | キーワードで施設名を部分一致検索できる | 実装済み | |
| B-10 | キーワード検索（施設コード） | 検索機能 | キーワードで施設コードを部分一致検索できる | 実装済み | |
| B-11 | キーワード検索（都道府県） | 検索機能 | キーワードで都道府県を部分一致検索できる | 実装済み | |
| B-12 | 種別フィルタ | 検索機能 | 特定の施設種別でフィルタリングできる | 実装済み | |
| B-13 | ステータスフィルタ | 検索機能 | 稼働ステータスでフィルタリングできる | 実装済み | |
| B-14 | キーワードとフィルタの複合検索 | 検索機能 | キーワード、種別、ステータスを組み合わせて検索できる | 実装済み | |
| B-15 | 検索条件なし | 検索機能 | 検索条件がない場合は全施設を取得できる | 実装済み | |

### 5.2 Frontend（Vitest + RTL） — 予定: `tests/frontend/facility-table.test.tsx`

| ID | シナリオ | 観点 | 期待結果 | 自動化 | 備考 |
| --- | --- | --- | --- | --- | --- |
| F-01 | 一覧表示 | 表示 | 施設コード、名称、種別、所在地、ステータスが表に表示される | 実装済み | 並び順と空欄表示（`-`）確認 |
| F-02 | 空状態表示 | 状態 | データなしの場合は「施設が登録されていません」メッセージ | 未実装 | |
| F-03 | 読み込み状態 | 状態 | フェッチ中はローディング表示 | 未実装 | |
| F-04 | フィルタ/検索（将来） | 機能 | 機能実装時にテスト追加 | N/A | 初版では非対応 |
| F-05 | 新規登録フロー | 正常系 | 入力値で `create.mutate` が呼ばれ、成功時にモーダルが閉じる | 実装済み | 必須項目と optional null 変換 |
| F-06 | 必須項目不足 | 異常系 | コード/名称未入力でブラウザ検証 or エラー表示 | 未実装 | |
| F-07 | コード重複エラー表示 | 異常系 | エラー Alert に API メッセージが表示される | 未実装 | モックでエラー返却 |
| F-08 | 編集フロー | 正常系 | 既存値がモーダルに反映され、更新 payload を送信 | 実装済み | 各フィールドの null/空文字変換確認 |
| F-09 | 無効化操作 | 正常系 | 確認ダイアログ OK 後、`deactivate.mutate` が呼ばれ一覧更新 | 実装済み | |
| F-10 | 住所入力補助（任意） | UX | 郵便番号入力で補完される場合、モックで挙動確認 | 未実装 | 実装後に適用 |

### 5.3 E2E（Playwright） — 予定: `tests/e2e/facility-crud.spec.ts`

| ID | シナリオ | 観点 | 期待結果 | 自動化 | 備考 |
| --- | --- | --- | --- | --- | --- |
| E-01 | 施設 CRUD 一連操作 | 正常系 | 追加 → 編集 → 無効化 まで UI が更新される | 未実装 | |
| E-02 | 無効化キャンセル | 異常系（利用者操作） | ダイアログでキャンセルすると変更なし | 未実装 | |
| E-03 | コード重複エラー | 異常系 | 重複登録でエラー表示、一覧に追加されない | 未実装 | |
| E-04 | フォームバリデーション | 異常系 | 必須項目未入力で保存できない | 未実装 | |
| E-05 | 住所・連絡先確認 | 表示 | 入力した住所/電話/メールが一覧に反映される | 未実装 | |

## 6. カバレッジマッピング
- **Backend**: CRUD 正常系、重複チェック、期間バリデーション、論理削除をカバー（B-01〜B-08）。
- **Frontend**: UI 表示とモーダル入力、バリデーション、エラーハンドリング（F-01〜F-09）。
- **E2E**: 実際のユーザー操作による主要フローとエラー確認（E-01〜E-05）。

## 7. 今後の拡張テスト案
- CSV インポート/エクスポート機能追加時のファイル検証。
- GIS 座標入力時の地図表示や逆ジオコーディング連携テスト。
- 施設種別・ステータス別フィルタリングが実装された際の複雑検索シナリオ。
- 外部システム連携フラグ (`isIntegrated`) の更新と同期結果確認。

## 8. 留意事項
- API エラーコード／メッセージが確定したら、テストケース内の期待結果を同期する。
- Playwright で `confirm` を扱う場合は `page.on("dialog")` で受け取り、OK/キャンセルを明示する。
- テストデータのクリーンアップ（とくに E2E）を行い、本番データと混在しないよう注意。
- 住所・電話番号のフォーマットは業務要件に合わせてテスト基準を整備する。***
