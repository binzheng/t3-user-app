# å„ªå…ˆåº¦é«˜ãƒ»ä¸­ã®å•é¡Œå¯¾å¿œãƒ¬ãƒãƒ¼ãƒˆ

**å®Ÿæ–½æ—¥**: 2025-11-02  
**å¯¾å¿œè€…**: AI Agent

## å¯¾å¿œå®Œäº†é …ç›®

### ğŸ”´ å„ªå…ˆåº¦é«˜ï¼ˆMajorï¼‰

#### 1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ âœ…

**å•é¡Œ**: React production buildã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ãŸãŸã‚ã€act()ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

**å¯¾å¿œå†…å®¹**:
- `vitest.setup.ts`ã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã®åˆæœŸåŒ–å‡¦ç†ã‚’è¿½åŠ 
- `vitest.config.ts`ã«setupFilesã‚’è¨­å®š
- `package.json`ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã«NODE_ENV=testã‚’è¿½åŠ 
- matchMediaã®ãƒ¢ãƒƒã‚¯ã‚’è¿½åŠ ï¼ˆMaterial-UIå¯¾å¿œï¼‰

**çµæœ**: 
```
âœ“ tests/backend/user/use-cases.test.ts  (13 tests)
âœ“ tests/backend/facility/use-cases.test.ts  (14 tests)
âœ“ tests/frontend/user-table.test.tsx  (4 tests)
âœ“ tests/frontend/facility-table.test.tsx  (4 tests)

Test Files  4 passed (4)
Tests  35 passed (35)
```

---

#### 2. ã‚¨ãƒ©ãƒ¼å¢ƒç•Œã®å®Ÿè£… âœ…

**å¯¾å¿œå†…å®¹**:
- `src/presentation/components/common/error-boundary.tsx`ã‚’ä½œæˆ
- React.Componentãƒ™ãƒ¼ã‚¹ã®ã‚¨ãƒ©ãƒ¼å¢ƒç•Œã‚’å®Ÿè£…
- é–‹ç™ºç’°å¢ƒã§ã¯ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤ºã€æœ¬ç•ªç’°å¢ƒã§ã¯æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹/ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã‚’é…ç½®
- `src/app/layout.tsx`ã§ErrorBoundaryã‚’é©ç”¨

**æ©Ÿèƒ½**:
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§ã‚­ãƒ£ãƒƒãƒã•ã‚Œãªã„ã‚¨ãƒ©ãƒ¼ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ç”»é¢è¡¨ç¤º
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›

---

### ğŸŸ¡ å„ªå…ˆåº¦ä¸­ï¼ˆMinorï¼‰

#### 3. å…±é€šå‹å®šç¾©ã®æŠ½å‡º âœ…

**å¯¾å¿œå†…å®¹**:
- `src/presentation/utils/form-helpers.ts`ã‚’ä½œæˆ
- ä»¥ä¸‹ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’å®Ÿè£…:
  - `toOptional<T>`: ç©ºæ–‡å­—åˆ—ã‚’undefinedã«å¤‰æ›
  - `toNullable<T>`: ç©ºæ–‡å­—åˆ—ã‚’nullã«å¤‰æ›
  - `toOptionalNumber`: æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã¸ã®å¤‰æ›ï¼ˆoptionalï¼‰
  - `toNullableNumber`: æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã¸ã®å¤‰æ›ï¼ˆnullableï¼‰
  - `toDateValue`: æ—¥ä»˜æ–‡å­—åˆ—ã‹ã‚‰Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  - `toDateOrNull`: nullableæ—¥ä»˜å¤‰æ›

**åŠ¹æœ**:
- user-table.tsxã¨facility-table.tsxã§é‡è¤‡ã—ã¦ã„ãŸã‚³ãƒ¼ãƒ‰å‰Šé™¤å¯èƒ½
- å‹å®‰å…¨ãªå€¤å¤‰æ›å‡¦ç†ã‚’å…±é€šåŒ–
- å°†æ¥çš„ã«ã“ã‚Œã‚‰ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§åˆ©ç”¨å¯èƒ½

---

#### 4. Loading/ErrorçŠ¶æ…‹ã®å…±é€šåŒ– âœ…

**å¯¾å¿œå†…å®¹**:
- `src/presentation/components/common/query-state-handler.tsx`ã‚’ä½œæˆ
- ã‚¸ã‚§ãƒãƒªãƒƒã‚¯å‹ã‚’ä½¿ç”¨ã—ãŸæ±ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
- ä»¥ä¸‹ã®çŠ¶æ…‹ã‚’è‡ªå‹•ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:
  - LoadingçŠ¶æ…‹ï¼ˆCircularProgress + ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
  - ErrorçŠ¶æ…‹ï¼ˆAlertã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰
  - ç©ºçŠ¶æ…‹ï¼ˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
  - ãƒ‡ãƒ¼ã‚¿å­˜åœ¨æ™‚ã®å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

**ä½¿ç”¨ä¾‹**:
```typescript
<QueryStateHandler
  isLoading={isLoading}
  error={error}
  data={users}
  emptyMessage="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"
>
  {(users) => <UserList users={users} />}
</QueryStateHandler>
```

---

#### 5. tRPCã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ¨™æº–åŒ– âœ…

**å¯¾å¿œå†…å®¹**:
- `src/server/trpc/utils/error-handler.ts`ã‚’ä½œæˆ
- `handleUseCaseError`é–¢æ•°ã‚’å®Ÿè£…
- ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã‚’æ¨™æº–çš„ã«å¤‰æ›:
  - USER_NOT_FOUND â†’ TRPCError (NOT_FOUND)
  - EMAIL_ALREADY_EXISTS â†’ TRPCError (CONFLICT)
  - FACILITY_NOT_FOUND â†’ TRPCError (NOT_FOUND)
  - FACILITY_CODE_EXISTS â†’ TRPCError (CONFLICT)
  - ãã®ä»– â†’ INTERNAL_SERVER_ERROR

**é©ç”¨ç®‡æ‰€**:
- `src/server/trpc/routers/user.ts`: create, update, delete
- `src/server/trpc/routers/facility.ts`: create, update, deactivate

**åŠ¹æœ**:
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã®é‡è¤‡ã‚’æ’é™¤
- ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- æ–°ã—ã„ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã®è¿½åŠ ãŒå®¹æ˜“

---

## ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

```
src/
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ common/
â”‚   â”‚       â”œâ”€â”€ error-boundary.tsx       # NEW
â”‚   â”‚       â”œâ”€â”€ query-state-handler.tsx  # NEW
â”‚   â”‚       â””â”€â”€ index.ts                 # NEW
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ form-helpers.ts              # NEW
â”œâ”€â”€ server/
â”‚   â””â”€â”€ trpc/
â”‚       â””â”€â”€ utils/
â”‚           â””â”€â”€ error-handler.ts         # NEW
vitest.setup.ts                          # NEW
```

## å¤‰æ›´ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

```
src/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ layout.tsx                       # ErrorBoundaryè¿½åŠ 
â”œâ”€â”€ server/
â”‚   â””â”€â”€ trpc/
â”‚       â””â”€â”€ routers/
â”‚           â”œâ”€â”€ user.ts                  # handleUseCaseErrorä½¿ç”¨
â”‚           â””â”€â”€ facility.ts              # handleUseCaseErrorä½¿ç”¨
vitest.config.ts                         # setupFilesè¿½åŠ 
package.json                             # ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆæ›´æ–°
```

## ãƒ†ã‚¹ãƒˆçµæœ

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«é€šé:
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ: 27ãƒ†ã‚¹ãƒˆï¼ˆuser: 13, facility: 14ï¼‰
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ: 8ãƒ†ã‚¹ãƒˆï¼ˆuser: 4, facility: 4ï¼‰
- **åˆè¨ˆ**: 35ãƒ†ã‚¹ãƒˆå…¨ã¦æˆåŠŸ âœ…

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæœªå¯¾å¿œã®å„ªå…ˆåº¦ä½é …ç›®ï¼‰

1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºã®çµ±ä¸€ï¼ˆESLintãƒ«ãƒ¼ãƒ«è¿½åŠ æ¨å¥¨ï¼‰
2. ä¸è¦ãªã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤
3. ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ã®å®šæ•°åŒ–
4. facility-table.tsxã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ†å‰²ï¼ˆ800è¡Œè¶…ã®ãŸã‚ï¼‰

## ã¾ã¨ã‚

å„ªå…ˆåº¦é«˜ãƒ»ä¸­ã®å…¨é …ç›®ã‚’å¯¾å¿œã—ã¾ã—ãŸã€‚ç‰¹ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã®ã‚¨ãƒ©ãƒ¼è§£æ¶ˆã¨ã‚¨ãƒ©ãƒ¼å¢ƒç•Œã®å®Ÿè£…ã«ã‚ˆã‚Šã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®å“è³ªã¨å®‰å®šæ€§ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã—ãŸã€‚å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä½œæˆã«ã‚ˆã‚Šã€ä»Šå¾Œã®é–‹ç™ºåŠ¹ç‡ã‚‚æ”¹å–„ã•ã‚Œã¾ã™ã€‚
