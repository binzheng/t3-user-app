# AI エージェント作業合意

## プロジェクト範囲
- 単一の Next.js（T3 スタック）アプリ内でフロントとバックエンドを層分離して構築する。
- ユーザー管理と施設マスタ管理をコア機能とし、共通レイアウト（ヘッダー＋サイドメニュー）を提供する。
- 主なデータストアとして PostgreSQL を採用し、ローカルでは Podman ベースのインスタンスを提供する。
- フロントエンドのコンポーネントライブラリに Material UI を採用する。
- 自動テストと CI/CD パイプラインを必須要件として実装する。

- ルート直下に単一の `package.json` を置き、`src` 配下に `app` / `presentation` / `domain` / `application` / `infrastructure` / `server` を配置する。
- ドキュメントは `docs/` にまとめ、本ファイルで AI 向けルールを最新状態に保つ。
- パッケージ管理は pnpm、ORM は Prisma、フロントとバックエンド間の型安全な通信は tRPC を利用する。
- 共通ロジックや設定は `src` 内の適切な層で共有する。

## 開発プラクティス
- 新機能の導入前後で関連ドキュメント（`docs/project-plan.md`、仕様書、テスト計画など）を更新し、実装と差分がないように保つ。
- **仕様変更時は、関連するテスト項目とテストコードを自動的に更新・追加する。**
  - 画面仕様の変更 → テスト仕様書の更新 + E2Eテストの修正
  - API仕様の変更 → インテグレーションテストの修正
  - ビジネスロジックの変更 → ユニットテストの修正
  - 新機能追加 → 対応するテストケースとテストコードを追加
- フロントとバックエンドの責務を明確に分離し、層間の参照は定義済みインターフェースを介して行う。
- クリーンアーキテクチャに沿ってドメイン層・ユースケース層・アダプタ層を分離し、各層の疎結合を維持する。
- ソースフォルダ構成（domain/application/infrastructure/presentation/server）を守り、層間依存は内側 → 外側の一方向に限定する。
- フロントエンドのソースコードは機能単位・責務単位で適切に分割し、1ファイルが肥大化しないように構成する。
- `src/presentation/components` と `src/server/application/use-cases` は機能ごとにサブフォルダを設け、責務別に整理する。
- データベーススキーマの変更は必ず Prisma マイグレーションに反映する。
- ローカル開発はリポジトリ内に定義したスクリプト／コマンドを用いて Podman（podman-compose）上の PostgreSQL に依存する。
- テストコードは `tests/` 配下に配置し、ユニット、インテグレーション、E2E をカバーする。

## テストと CI/CD
- ユニット／インテグレーション／E2E を実行するコマンドを提供し、CI で自動的に実行されるようにする。
- GitHub Actions（または同等）で Lint、テスト、ビルド、デプロイを実行するよう構成する。
- テストデータの分離（シード／テアダウン）を徹底し、テストの決定性を保つ。

## コミュニケーションと検証
- 要求に対応する際は、本ルールとの整合性を確認し、逸脱事項があれば実装前に共有する。
- 作業を阻害する可能性のある制約（ツール、権限、環境など）があれば速やかに提示する。
- 要件が本合意と矛盾する場合は、解消に向けて確認を取る。
